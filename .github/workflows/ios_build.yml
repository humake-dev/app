name: iOS Build

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '>=20'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Setup Ruby 
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # 1Ô∏è‚É£ RN Codegen Î®ºÏ†Ä Ïã§Ìñâ
      - name: Run RN Codegen
        run: |
          mkdir -p ios/build/generated
          node node_modules/react-native/scripts/generate-codegen-artifacts.js \
            -p . -t ios -o ios/build/generated

      # 2Ô∏è‚É£ CocoaPods ÏÑ§Ïπò
      - name: Install CocoaPods
        run: |
          cd ios
          export BUNDLE_GEMFILE=Gemfile
          export NODE_BINARY=$(which node)
          export RCT_NEW_ARCH_ENABLED=0
          bundle install
          bundle exec pod install

      # 3Ô∏è‚É£ Preflight check
      - name: Preflight Codegen sanity
        run: |
          set -e
          echo "üîç Preflight Codegen check started"
          if grep -R "Codegen did not run properly" ios -n; then
            echo "‚ùå Found 'Codegen did not run properly'"
            exit 1
          fi
          if grep -R "FBReactNativeSpec" ios/Pods >/dev/null; then
            echo "‚ùå FBReactNativeSpec detected"
            exit 1
          fi
          if grep -R "React-Codegen" ios/Pods >/dev/null; then
            echo "‚ùå React-Codegen references detected"
            exit 1
          fi
          echo "‚úÖ Preflight Codegen check passed"

      # 4Ô∏è‚É£ Symlink ÏÉùÏÑ± (Pods Headers)
      - name: Fix React-Codegen symlink
        run: |
          mkdir -p ios/Pods/Headers/Public
          ln -sf ../../build/generated ios/Pods/Headers/Public/React-Codegen
          echo "‚úÖ Symlink created"

      # 5Ô∏è‚É£ Certificates / Provisioning
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v6.0.0
        with:
          p12-file-base64: ${{ secrets.IOS_CERT_BASE64 }}
          p12-password: ${{ secrets.IOS_CERT_PASSWORD }}
          keychain: build_keychain
          create-keychain: true
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}

      - name: Setup provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > /tmp/profile.mobileprovision
          UUID=$(security cms -D -i /tmp/profile.mobileprovision | plutil -extract UUID raw -)
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          chmod 644 ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision

      # 6Ô∏è‚É£ Build
      - name: Build archive
        run: |
          set -o pipefail
          xcodebuild \
            -workspace ios/humake_app.xcworkspace \
            -scheme humake_app \
            -configuration Release \
            -archivePath build/humake_app.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=7FGDKUA4PZ \
            PRODUCT_BUNDLE_IDENTIFIER=kr.co.humake \
            PROVISIONING_PROFILE=5fb10f42-9454-4eb8-9c41-11ff94617b2f \
            CODE_SIGN_IDENTITY="iPhone Distribution" \
            archive \
            -verbose | tee xcodebuild.log

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/humake_app.xcarchive \
            -exportPath build \
            -exportOptionsPlist ios/exportOptions.plist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipa
          path: build/*.ipa