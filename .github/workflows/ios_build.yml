name: iOS Build

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '>=20'

      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile

       

      - name: Setup Ruby 
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install CocoaPods
        run: |
          cd ios
          export BUNDLE_GEMFILE=Gemfile
          export NODE_BINARY=$(which node)
          bundle install
          bundle exec pod install
      
      - name: Run RN Codegen manually
        run: |
          node node_modules/react-native/scripts/generate-codegen-artifacts.js \
          -p . \
          -t ios \
          -o ios/build/generated       
          
      # --- Import certificates only ---
      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v6.0.0
        with:
          p12-file-base64: ${{ secrets.IOS_CERT_BASE64 }}
          p12-password: ${{ secrets.IOS_CERT_PASSWORD }}
          keychain: build_keychain           # <-- .keychain 붙이지 마세요
          create-keychain: true
          keychain-password: ${{ secrets.KEYCHAIN_PASSWORD }}
          
      - name: List code signing identities
        run: |
          security find-identity -v -p codesigning 

        
      # --- Provisioning profile manually ---
      - name: Setup provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles          
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > /tmp/profile.mobileprovision          
          UUID=$(security cms -D -i /tmp/profile.mobileprovision | plutil -extract UUID raw -)          
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          chmod 644 ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision | plutil -p -
      
      - name: Verify provisioning profiles
        run: |
          ls ~/Library/MobileDevice/Provisioning\ Profiles
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision | grep -E "Name|UUID|ApplicationIdentifier|TeamName"
      
      - name: Fix React-Codegen path (CI workaround)
        run: |
          mkdir -p ios/Pods/Headers/Public
          ln -sf ../..//build/generated/ios ios/Pods/Headers/Public/React-Codegen
          
      - name: Verify React-Codegen symlink
        run: |
          ls -l ios/Pods/Headers/Public/React-Codegen          
          
      - name: Build archive
        run: |
          set -o pipefail
          xcodebuild \
            -workspace ios/humake_app.xcworkspace \
            -scheme humake_app \
            -configuration Release \
            -archivePath build/humake_app.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=7FGDKUA4PZ \
            PRODUCT_BUNDLE_IDENTIFIER=kr.co.humake \
            PROVISIONING_PROFILE=5fb10f42-9454-4eb8-9c41-11ff94617b2f \
            CODE_SIGN_IDENTITY="iPhone Distribution" \
            archive \
            -verbose \
            | tee xcodebuild.log          
      - name: Extract errors
        if: always()
        run: |
          grep -E "error:|fatal error|CodeSign|Provisioning|No Accounts" xcodebuild.log || true            

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/humake_app.xcarchive \
            -exportPath build \
            -exportOptionsPlist ios/exportOptions.plist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipa
          path: build/*.ipa